name: update readme stats cards

on:
  schedule:
    - cron: "20 2 * * *"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - README.md
      - .github/workflows/readme-stats.yml

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: readme-stats
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate top languages (dark)
        uses: stats-organization/github-readme-stats-action@2d1ecd1a7becec017c1cd1e7bd626ef223266b32
        with:
          card: top-langs
          options: username=${{ github.repository_owner }}&langs_count=8&show_icons=true&locale=en&layout=compact&theme=onedark&hide_border=true&bg_color=0D1117
          path: img/top-langs-dark.svg

      - name: Generate top languages (light)
        uses: stats-organization/github-readme-stats-action@2d1ecd1a7becec017c1cd1e7bd626ef223266b32
        with:
          card: top-langs
          options: username=${{ github.repository_owner }}&langs_count=8&show_icons=true&locale=en&layout=compact&hide_border=true
          path: img/top-langs-light.svg

      - name: Generate stats (dark)
        uses: stats-organization/github-readme-stats-action@2d1ecd1a7becec017c1cd1e7bd626ef223266b32
        with:
          card: stats
          options: username=${{ github.repository_owner }}&show_icons=true&theme=onedark&hide_border=true&bg_color=0D1117
          path: img/github-stats-dark.svg

      - name: Generate stats (light)
        uses: stats-organization/github-readme-stats-action@2d1ecd1a7becec017c1cd1e7bd626ef223266b32
        with:
          card: stats
          options: username=${{ github.repository_owner }}&show_icons=true&hide_border=true
          path: img/github-stats-light.svg

      - name: Commit generated SVG files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add img/top-langs-dark.svg img/top-langs-light.svg img/github-stats-dark.svg img/github-stats-light.svg
          git diff --cached --quiet && exit 0
          git commit -m "chore: update profile stats cards"
          if git push; then
            exit 0
          fi

          # another push landed while this job was running; replay and retry once
          git pull --rebase origin main
          git push
